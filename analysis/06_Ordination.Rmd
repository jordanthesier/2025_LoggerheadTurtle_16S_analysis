---
title: "Between-Sample (Beta) Diversity of Microbes of Loggerhead Sea Turtles of Different
  Ages"
author: "Jordan"
date: "2025-04-15"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.path = "../figures/06_Ordination/")
```

# Goals 

1. Load in phyloseq data with rooted tree & colors and functions.  
2. Evaluate sequencing depth and remove samples, if needed.  
3. Normalize the read counts between samples.  
4. Calculate community **dis**similarities. Numbers between 0 and 1. If 0, completely similar versus if they are 1, then they're completely dissimilar.   
    a. **Sorensen**: Shared Species as a binary value: Abundance-unweighted 
    b. **Bray-Curtis**: Shared Abundant species: Abundance-weighted
    c. **(Abundance-)Weighted UNIFRAC**: Consider Abundant Species and where they fall on the tree  
5. Run statistics with functions from the vegan R package: 
    a. PERMANOVA with `adonis2()`.
    b. betadispR with `betadisper()` and `permutest()`. 
6. Visualize the community data with two unconstrained Ordinations:  
    a. **PCoA**: Linear Method. Eigenvalue = how much variation is explained by each axis. Choose to view axis 1, 2, 3, etc. and plot them together.  
    b. **NMDS**: Non-linear. Smush multiple Dimensions into 2 or 3 axes. Need to report Stress value (ideally <0.15).  

## Inputs 

1. We will need the `midpoint_rooted_physeq.RData`, which includes a rooted tree that we created in `analysis/04B_Phylogenetic_Tree_Inspection.Rmd`. 

## Outputs 

*This is an exciting analysis!!! We get to answer another one of our scientific questions!*

1. Calculated beta-diversity dissimilarity measures (*e.g.* Sorensen, Bray-Curtis, abundance-unweighted and -weighted UniFrac) across every sample. 
2. Ordination figures (*i.e.,* PCoA/NMDS) to include in the scientific paper that visualize the data as it relates to the scientific question.
3. Statistical tests (*i.e.,* PERMANOVA & betadisper) conveying the measured and quantified changes and patterns in biodiversity.

# Scientific Question / Interpretation 1

How does microbial diversity of Loggerhead sea turtles change with age?

- *Null Hypothesis:* Microbial composition (*e.g.* Sorensen, Bray-Curtis, abundance-unweighted and -weighted UniFrac) does not vary with age.
- *Alternative Hypothesis #1:* Microbial composition (*e.g.* Sorensen, Bray-Curtis, abundance-unweighted and -weighted UniFrac) will become more similar with age.
- *Alternative Hypothesis #2:* Rare members of the microbial community (*e.g.* Sorensen, abundance-unweighted UniFrac) are unique in juveniles compared to adults. 

# Set up 

## Timing of this script

```{r rmd-start}
# What time did we start running this script? 
start_time <- Sys.time()
```

## Set the seed

```{r set-seed}
set.seed(238428)
```

## Load Packages, colors & functions  
```{r load-packages}
pacman::p_load(tidyverse, devtools, phyloseq, patchwork, vegan, 
               install = FALSE)

# Load Colors 
source("code/colors.R")

# Load functions 
source("code/functions.R")
```

# 1. Load in the data 

```{r load-data}
# load phyloseq object
load("data/04_PhylogeneticTree/midpoint_rooted_physeq.RData")
midpoint_rooted_physeq

# Intuition check on seq depth
min(sample_sums(midpoint_rooted_physeq))
```

# Remove outlier sample
The minimum sequencing depth for the samples is 1,607 reads, then the next lowest is 17,372 reads. I want to remove this smallest one (16S0119C, sub-adult, cloacal) since this is a 15,765 read difference, and including this sample cut the number of ASVs in half (in a previously version of this analysis).

```{r remove-outlier}
midpoint_rooted_physeq <- 
  midpoint_rooted_physeq %>%
  subset_samples(names != "16S0119C") %>%
  # And remove any ASVs unique to this sample, just in case.
  prune_taxa(taxa_sums(.) > 0, .)

# Check that we now have 43 samples 
midpoint_rooted_physeq

# Create Metadata_df 
metadata_df <- 
  midpoint_rooted_physeq %>%
  sample_data() %>%
  data.frame()

```


# Normalizing the Read Depth 

## 2. Explore the Raw Read Counts 

```{r explore-read-counts, fig.width=6, fig.height=3}
# calculate read counts per sample 
raw_TotalSeqs_df <- 
  midpoint_rooted_physeq %>%
  # Calculate the total number of sequences/reads
  sample_sums() %>%
  data.frame()

# Take a look 
head(raw_TotalSeqs_df)

# Rename the column 
colnames(raw_TotalSeqs_df)[1] <- "TotalSeqs"

# add a new column of num_ASVs (RAW, non-noramlized # ASVs)
raw_TotalSeqsASVs_df <- 
  raw_TotalSeqs_df %>%
  mutate(num_ASVs = colSums(otu_table(midpoint_rooted_physeq) > 1))

#View(raw_TotalSeqsASVs_df)

# Plot histogram of seq depth 
rawSeq_histogram <- 
  raw_TotalSeqsASVs_df %>%
  ggplot(aes(x = TotalSeqs)) + 
  geom_histogram(bins = 50) + 
  scale_x_continuous(limits = c(0, 600000)) + 
  labs(title = "Raw Seq Depth Histogram") + 
  theme_bw()

# Plot Seq Depth versus num_ASVs
rawSeq_vs_numASV_plot <- 
  raw_TotalSeqsASVs_df %>%
  ggplot(aes(x = num_ASVs, y = TotalSeqs)) + 
  geom_point() + 
  scale_y_continuous(limits = c(0, 600000)) +
  geom_smooth(method = "lm") + 
  labs(title = "Seq Depth vs # ASVs") + 
  theme_bw()

# is it significant? 
summary(lm(TotalSeqs ~ num_ASVs, data = raw_TotalSeqsASVs_df))
# p value is very small, there is a significant relationship

# Put the two plots together.
rawSeq_histogram + rawSeq_vs_numASV_plot +
  plot_annotation(tag_levels = "A")
```

Interpretation 2: I scaled the read counts to 600,000 because the max number of reads in a sample is 569992. I cannot perform a beta-diversity analysis yet, I must scale my reads to accurately compare the data, since right now there is a significant relationship between the number of reads and ASVs.

Scaling reads creates a range in sequencing depth, while rarefaction does not.

  - But scaling is not super computationally intensive! 
  - The range is due to rounding.
  - min sequence depth * # ASVs in sample/ # sequences in sample

# 3. Scale Read Counts 

```{r scale-reads, fig.width=6, fig.height=3}
min(sample_sums(midpoint_rooted_physeq))

# Scale the reads 
scaled_physeq <- 
  midpoint_rooted_physeq %>%
  scale_reads(round = "matround")

# Look at it 
scaled_physeq

# compare to original - removing the outlier helped a lot, now we only lost ~500 ASVs instead of ~6,000 when we kept it
midpoint_rooted_physeq

# Look at it more!
#View(data.frame(otu_table(midpoint_rooted_physeq)))
#View(data.frame(otu_table(scaled_physeq)))

# Confirm seq read depth of scaled_physeq 
scaled_TotalSeqs_df <- 
  scaled_physeq %>%
  sample_sums() %>%
  data.frame()

colnames(scaled_TotalSeqs_df)[1] <- "TotalSeqs"

# add a new column of num_ASVs (RAW, non-noramlized # ASVs)
scaled_TotalSeqsASVs_df <- 
  scaled_TotalSeqs_df %>%
  mutate(num_ASVs = colSums(otu_table(scaled_physeq) > 1))

# Plot it! 
scaledSeq_histogram <- 
  scaled_TotalSeqs_df %>%
  ggplot(aes(x = TotalSeqs)) + 
  geom_histogram(bins = 50) + 
  labs(title = "Scaled Seq Depth Histogram") + 
  scale_x_continuous(limits = c(0, 20000)) + 
  theme_bw()

# Scaling always gives us a range! 
# MInimum sequences
min(scaled_TotalSeqs_df$TotalSeqs) 
# Total Range 
range(scaled_TotalSeqs_df)
# How many is that range? 81
range_seqs <- (max(scaled_TotalSeqs_df$TotalSeqs) - min(scaled_TotalSeqs_df$TotalSeqs))
range_seqs
# And in terms of percent? 0.5%
range_seqs/max(scaled_TotalSeqs_df$TotalSeqs)
#View(scaled_TotalSeqs_df)

# is it significant? 
summary(lm(TotalSeqs ~ num_ASVs, data = scaled_TotalSeqsASVs_df))
# p value now > 0.05, there is no significant relationship

# Set the axis min and max for the next plot 
max_y <- max(scaled_TotalSeqs_df$TotalSeqs) + 10
min_y <- min(scaled_TotalSeqs_df$TotalSeqs) - 10

# Now, draw the plot 
scaledSeq_vs_numASV_plot <- 
  scaled_TotalSeqsASVs_df %>%
  ggplot(aes(x = num_ASVs, y = TotalSeqs)) + 
  geom_point() + 
  scale_y_continuous(limits = c(min_y, max_y)) +
  geom_smooth(method = "lm") + 
  theme_bw() + 
  labs(title = "Scaled: Seq Depth vs # ASVs")

# Put the two plots together.
scaledSeq_histogram + scaledSeq_vs_numASV_plot +
  plot_annotation(tag_levels = "A")
```

Interpretation 3: I scaled the read counts to 20000 because after scaling the sequencing depth ranged from 17323 to 17404 across samples. This is a range of 81, which is only 0.5%. Additionally, the number of ASVs no longer rely on the numbers of sequences (p > 0.05), so this data should be sufficient to perform a beta-diversity analysis.

## Similarity versus Dissimilarity

In microbial ecology, **beta diversity** refers to the **similiarty or dissimilarity**, which represent the unique-ness between two microbial community samples. (Dis)similarity values range from **0 to 1**:

- **Similarity**: Values close to 1 = communities are the same whereas 0 = completely different communities. 
- **Dissimilarity**: Values close to 1 = the communities are unique whereas 0 refers to identical communities. 

Most ecological studies and ordination plots use **dissimilarity**. For some metrics like Jaccard and Sorensen, you’ll see formulas written as similarity—but it's easy to convert them. 

Different dissimilarity metrics emphasize different aspects of community differences—such as presence/absence, abundance, or evolutionary relatedness (phylogeny). Choosing the right metric depends on your scientific question! It is up to us as data analysts to run each of these dissimilarities on our microbial community samples. This multi-faceted approach will provide a multifaceted view of our microbial communities of interest.

## Common dissimilarity measures

### How do I choose the right dissimilarity metric?

| Scientific Question                                                             | Recommended Metric(s)              |
|----------------------------------------------------------------------------------|------------------------------------|
| Do the two environments share the same microbes, regardless of abundance?       | Jaccard, Sorensen             |
| How does abundance differ between communities?                                   | Bray-Curtis                        |
| Are there differences in the evolutionary history of microbes between samples?  | UniFrac (unweighted or weighted)   |
| Do dominant, evolutionarily distinct microbes vary in abundance?                | Weighted UniFrac                   |

Choosing the right dissimilarity measure starts with understanding what aspect of community difference you're trying to capture. If you're asking whether two environments simply contain the same taxa—regardless of how abundant those taxa are—then presence/absence-based measures like **Jaccard** or **Sorensen-Dice** are appropriate. These metrics are particularly useful when working with rarefied data, or when you're more concerned with community membership than abundance.

If you're interested in how **abundant** different taxa are across communities—especially if dominant taxa may be ecologically important—then an abundance-based metric like **Bray-Curtis** is a better choice. Bray-Curtis emphasizes changes in relative abundance and is sensitive to shifts in dominant taxa, making it useful for studying processes like competitive exclusion or resource-driven community turnover.

When your data include **phylogenetic information**—for example, from 16S rRNA gene amplicon sequencing—you may want to use **UniFrac** metrics. **Unweighted UniFrac** is good for detecting evolutionary differences based on presence/absence (i.e., whether the communities harbor different lineages), while **Weighted UniFrac** incorporates both **phylogeny and abundance**, allowing you to explore whether communities differ in their evolutionary makeup **and** in the dominance of certain lineages. These are especially useful when you care about deep evolutionary divergence or when function may correlate with phylogeny.

Practical considerations also matter. For example, UniFrac requires a phylogenetic tree, which takes time and computation to build; Bray-Curtis and Jaccard don’t. Some metrics are also more sensitive to sampling depth and rare taxa, so normalization or rarefaction methods may be necessary before analysis.

In short, let your **ecological question** guide your metric choice: use **presence/absence** metrics to assess "who's there," **abundance-based** metrics to examine "how much is there," and **phylogenetic** metrics to explore "how evolutionarily different are these communities." Often, using **multiple metrics in parallel** can help reveal different facets of the data and strengthen your ecological interpretations.

These dissimilarity measures are foundational tools in microbial ecology and are often visualized using **ordination methods** (e.g., PCoA, NMDS) to interpret community shifts across environments, treatments, or gradients.

| Metric              | Type                | Similarity Formula | Dissimilarity Formula       | Uses Abundance | Uses Phylogeny |
|---------------------|---------------------|--------------------|-----------------------------|----------------|----------------|
| Jaccard             | Presence/absence    | \( \frac{A}{A+B+C} \) | \( \frac{B+C}{A+B+C} \)     | ❌             | ❌             |
| Sorensen-Dice       | Presence/absence    | \( \frac{2A}{2A+B+C} \) | \( \frac{B+C}{2A+B+C} \)     | ❌             | ❌             |
| Bray-Curtis         | Abundance-based     | —                  | \( \frac{\sum |a_i - b_i|}{\sum (a_i + b_i)} \) | ✅ | ❌ |
| Unweighted UniFrac  | Phylogenetic + presence/absence | — | \( \frac{\text{unique branch}}{\text{total branch}} \) | ❌ | ✅ |
| Weighted UniFrac    | Phylogenetic + abundance-based | — | \( \frac{\text{weighted unique branch}}{\text{total branch}} \) | ✅ | ✅ |

# 4. Calculating dissimilarity

Now, let's make distance objects of each of the dissimiliarity measures above! 

```{r calc-dissimilarity}
# Sorensen Dissimiliarty
scaled_sorensen_dist <- phyloseq::distance(scaled_physeq, method = "bray", binary = TRUE)

# What does it look like? 
class(scaled_sorensen_dist)
str(scaled_sorensen_dist)
#head(as.matrix(scaled_sorensen_dist))

# Bray-Curtis Dissimiliarty
scaled_bray_dist <- phyloseq::distance(scaled_physeq, method = "bray", binary = FALSE)

# Abundance-Unweighted UniFrac
scaled_uUnifrac_dist <- phyloseq::distance(scaled_physeq, method = "unifrac")

# Abundance-Weighted UniFrac
scaled_wUnifrac_dist <- phyloseq::distance(scaled_physeq, method = "wunifrac")
```

Interpretation 4: I am curious about the abundance of rare microbes in different age groups, so Sorensen Dissimilarity relates most to my scientific question.

# 5a. PERMANOVA: Testing Means/Centroids

The goal of PERMANOVA is to ask: *Do the centroids (i.e., means) differ between groups?*  

**PERMANOVA** stands for **Permutational Multivariate Analysis of Variance**. It is a statistical test used in microbial ecology to determine whether the composition of microbial communities differs significantly between groups—for example, between different treatment conditions, time points, or sample types.

Unlike traditional ANOVA, which compares means of univariate data, PERMANOVA works on a **distance or dissimilarity matrix** (like Bray-Curtis or UniFrac). It assesses whether the **centroids** (multivariate means) of different groups in that distance space are significantly farther apart than we’d expect by chance. The test uses permutations to randomly shuffle group labels and calculate a distribution of test statistics, allowing it to compute a **p-value** without assuming normality—making it well-suited for ecological data, which are often non-normal and complex.

To run PERMANOVA, we will first compute a dissimilarity matrix between all pairs of samples (like we just did! 😁), and then test whether the variation **between groups** is greater than the variation **within groups**. A low p-value (typically < 0.05) suggests that community composition differs significantly between the groups being compared.

However, PERMANOVA is **sensitive to differences in within-group dispersion** (*i.e.,* variability). If one group is much more variable than another, PERMANOVA might detect a significant result even if the centroids aren't truly different. Because of this, it's good practice to also run a **test for homogeneity of dispersion** (*e.g.,* `betadisper` in R) to check that group variances are comparable, which we will do next!

### Summary Table of Useful `adonis2()` Parameters

| Parameter      | Purpose                                           | When to Use                                                   |
|----------------|---------------------------------------------------|----------------------------------------------------------------|
| `permutations` | Number of permutations for p-value calculation   | Always (use 9999+ for more stable results)                     |
| `strata`       | Restrict permutations within groups               | For paired samples, repeated measures, or blocks               |
| `by`           | Controls how model terms are tested              | Use `"margin"` to test each variable while adjusting for others |
| `method`       | Calculate distance matrix internally              | Only if supplying a raw OTU/ASV table                          |
| `sqrt.dist`    | Apply square-root transformation to distances     | Rarely needed; used in specific workflows                      |
| `parallel`     | Run permutations using multiple CPU cores         | Speeds up large analyses with many permutations                |

## Categorical & Continuous Variables in PERMANOVA

`adonis2()` can also be run on continuous variables — and it’s actually a powerful way to test whether variation in microbial community composition is associated with continuous environmental or biological gradients (*e.g.,* pH, temperature, nutrient concentration, latitude, host age, etc.). In `adonis2()`, continuous variables are treated as predictors in a linear model-like framework. The test evaluates whether changes in the continuous variable are significantly associated with shifts in microbial community composition (as measured by your distance matrix).

For now, we will focus on comparing the Sorensen and the Bray-Curtis. More on UniFrac soon! 

### Sorensen

```{r PERMANOVA-categorical-sorensen}
# Sorensen
## 1. Run with by = terms for R² values, sensitive to order of variables! 
## ALWAYS check and confirm the order of your terms and how they interact with each other.  

adonis2(scaled_sorensen_dist ~ AgeRange, data = metadata_df)

sorensen_AgeRange_adonis_terms1 <- adonis2(scaled_sorensen_dist ~ AgeRange * SampleSite, data = metadata_df, by = "terms")
sorensen_AgeRange_adonis_terms1

# Check the order of the terms
sorensen_AgeRange_adonis_terms2 <- adonis2(scaled_sorensen_dist ~ SampleSite * AgeRange, data = metadata_df, by = "terms")
sorensen_AgeRange_adonis_terms2

## 2. Run with by = "margin" for marginal p-values, which we can compare to the residuals from the first one. 
sorensen_AgeRange_adonis_margin <- adonis2(scaled_sorensen_dist ~ SampleSite * AgeRange, data = metadata_df, by = "margin")
sorensen_AgeRange_adonis_margin
```

### Understanding PERMANOVA output: 

- **Pr(>F) Interpretation:** The p-value. Is it "*significant*"?  
    - This represents the "*probability of observing an F-statistic this extreme (or more extreme), assuming the null hypothesis is true.*" In essence, this is the **p-value** from the permutation test. This value tells us whether the variance explained by a variable (or interaction) is significantly greater than expected by chance.
- **R^2^ value Interpretation:** How much variation is explained by this variable—an effect size.
    - Not dependent on sample size. 
    - Interpretable across studies! 
    - R^2^ (also called “pseudo R^2^” in PERMANOVA) is the proportion of total variation in the multivariate data that is explained by a specific variable or interaction.
        - R^2^ = 0.25 means that the term explains 25% of the variation in the community composition.
        - R^2^ = 0.03 means that the term explains only 3% of variation — possibly statistically significant but a small effect. This is important because 3% is not much variation! So, therefore, even it if is *significant* based on the p-value, it explains an *insignificant* amount of variation. 
- **F-statistic Interpretation:** How strongly a variable separates groups, relative to residuals. 
    - Higher F-values tell us that there is stronger separation of groups. he F-statistic is a ratio of explained to unexplained variation, adjusted for degrees of freedom — similar to traditional ANOVA, but applied to a distance matrix (like Bray-Curtis, Jaccard, *etc.*). It tells you how much more variation is explained by the model (with your term included) compared to the residual (unexplained) variation.

### Interpreting PERMANOVA

So, as it applies to the Sorensen Dissimilarity, we can already draw a few conclusions about our data! We can state that: 

1. **SampleSite** is the strongest factor, explaining ~`r round(sorensen_AgeRange_adonis_terms1$R2[2]*100, digits = 0)`% of the variation in microbial community composition, which is statistically significant based on the p-value of <`r sorensen_AgeRange_adonis_terms1$"Pr(>F)"[2]`. This suggests sample site plays a major role in structuring the turtle microbial community.
2. **AgeRange** is also contributing significantly (~`r round(sorensen_AgeRange_adonis_terms1$R2[1]*100, digits = 0)`% of variation, with a significant p-value of <`r sorensen_AgeRange_adonis_terms1$"Pr(>F)"[1]`). This suggests age also plays a major role in structuring the turtle microbial community.
3.	The **interaction between AgeRange and SampleSite** explains an additional ~`r round(sorensen_AgeRange_adonis_terms1$R2[3]*100, digits = 0)`% of the variation, with a p-value of `r sorensen_AgeRange_adonis_terms1$"Pr(>F)"[3]`, meaning this interaction is not significantly impacting microbial community structure. However, more variation is explained by the interaction between AgeRange and SampleSite (8%) than AgeRange alone (7%), but AgeRange alone separates groups more than this interaction (F-stat of 1.7 vs 0.9).
4. Finally, the total residiuals of the model is ~`r round(sorensen_AgeRange_adonis_terms1$R2[4]*100, digits = 0)`% of the variation remains unexplained by these variables, which is quite a lot.

#### Biological takeaway:

AgeRange and SampleSite shape microbial beta diversity in this dataset based off of shared presence/absence of ASVs as it relates to the Sorensen dissimilarity. The null interaction effect suggests that spatial dynamics (*e.g.,* sample site) is homogeneous across the turtle microbiomes of different ages.

**We will also explore the role that abundance plays in shaping microbial community composition using the Bray-Curtis Dissimilarity.**

### PERMANOVA: Continuous variable with Weight 

```{r PERMANOVA-sorensen-weight}
## Now, let's add a continuous variable. 
sorensen_weight_adonis_terms1 <- adonis2(scaled_sorensen_dist ~ AgeRange * SampleSite * Weight, data = metadata_df, by = "terms")
sorensen_weight_adonis_terms1

# Check different order 
sorensen_weight_adonis_terms2 <- adonis2(scaled_sorensen_dist ~ Weight * AgeRange * SampleSite, data = metadata_df, by = "terms")
sorensen_weight_adonis_terms2
```

**In the first model** where `Weight` is the final term, `Weight` explains only 3% of the variation in community composition after accounting for AgeRange and SampleSite. It is statistically significant (p < 0.030), so `Weight` has an independent effect. *But in this model, weight is tested after AgeRange and SampleSite, so its effect is adjusted for their contributions.*

**In the second model** `Weight` now explains 4.7% of the variation, which is a bit higher! Here `Weight` is also significant (P < 0.001), indicating a strong association between turtle weight and community structure. However, weight is tested first, so it “gets credit” for shared variance with station and also date. 

These two models together show that: 

1. Weight is important (significant in both models).
3. Weight likely co-varies with AgeRange, which makes sense as turtles grow when they become older.
4. When interpreting effect size, contextualize the model structure:
    a. *Model 1:* Weight’s unique contribution
    b. *Model 2:* Weight’s overall contribution, overlapping with other factors. 
    
### Bray-Curtis

```{r PERMANOVA-categorical-bray}
# Bray-Curtis
## ALWAYS check and confirm the order of your terms and how they interact with each other.  
adonis2(scaled_bray_dist ~ AgeRange, data = metadata_df)

bray_AgeRange_adonis_terms1 <- adonis2(scaled_bray_dist ~ AgeRange * SampleSite, data = metadata_df, by = "terms")
bray_AgeRange_adonis_terms1

bray_AgeRange_adonis_terms2 <- adonis2(scaled_bray_dist ~ SampleSite * AgeRange, data = metadata_df, by = "terms")
bray_AgeRange_adonis_terms2


## 2. Run with by = "margin" for marginal p-values
bray_AgeRange_adonis_margin <- adonis2(scaled_bray_dist ~ SampleSite * AgeRange, data = metadata_df, by = "margin")
bray_AgeRange_adonis_margin
```

#### Interpreting PERMANOVA

So, as it applies to the Sorensen Dissimilarity, we can already draw a few conclusions about our data! We can state that: 

1. **SampleSite** is the strongest factor, explaining ~`r round(bray_AgeRange_adonis_terms1$R2[2]*100, digits = 0)`% of the variation in microbial community composition, which is statistically significant based on the p-value of <`r bray_AgeRange_adonis_terms1$"Pr(>F)"[2]`. This suggests sample site plays a major role in structuring the turtle microbial community.
2. **AgeRange** is also contributing significantly (~`r round(bray_AgeRange_adonis_terms1$R2[1]*100, digits = 0)`% of variation, with a significant p-value of <`r bray_AgeRange_adonis_terms1$"Pr(>F)"[1]`). This suggests age also plays a major role in structuring the turtle microbial community.
3.	The **interaction between AgeRange and SampleSite** explains an additional ~`r round(bray_AgeRange_adonis_terms1$R2[3]*100, digits = 0)`% of the variation, with a pvalue of <`r bray_AgeRange_adonis_terms1$"Pr(>F)"[3]`, meaning this interaction is not significantly impacting microbial community structure. However, more variation is explained by the interaction between AgeRange and SampleSite (9%) than AgeRange alone (6%), but AgeRange alone separates groups more than this interaction (F-stat of 1.3 vs 1.1).
4. Finally, the total residiuals of the model is ~`r round(bray_AgeRange_adonis_terms1$R2[4]*100, digits = 0)`% of the variation remains unexplained by these variables, which is quite a lot.

### Comparing Sorensen & Bray Curtis Results 

- Both models revealed AgeRange and SampleSite significantly effect microbial community structure, without significant interactions.
- Both models explain the same amount of total variation, suggesting presence/absence and abundance capture similar ecological structure.
- The higher R^2^ (~`r round(sorensen_AgeRange_adonis_terms1$R2[1]*100, digits = 0)`% vs. ~`r round(bray_AgeRange_adonis_terms1$R2[1]*100, digits = 0)`%) and F-stat (~`r round(sorensen_AgeRange_adonis_terms1$F[1], digits = 0)` vs. ~`r round(bray_AgeRange_adonis_terms1$F[1], digits = 0)`) for AgeRange but not SampleSite (~`r round(sorensen_AgeRange_adonis_terms1$R2[2]*100, digits = 0)`% vs. ~`r round(bray_AgeRange_adonis_terms1$R2[2]*100, digits = 0)`% and ~`r round(sorensen_AgeRange_adonis_terms1$F[2], digits = 0)` vs. ~`r round(bray_AgeRange_adonis_terms1$F[2], digits = 0)`) in Sorensen indicates that rare species across turtle ages may be playing a bigger role than rare species across sample sites.

*In other words:* 

Community composition is strongly influenced by AgeRange and SampleSite in both models, but the Sorensen model (presence/absence) reveals more separation of groups by age. This suggests that rare species play a major role in structuring microbial communities in this system across age ranges. 

### PERMANOVA: Continuous variable with Weight

```{r PERMANOVA-bray-weight}
## Now, let's add a continuous variable. 
bray_weight_adonis_terms1 <- adonis2(scaled_bray_dist ~ AgeRange * SampleSite * Weight, data = metadata_df, by = "terms")
bray_weight_adonis_terms1

# Check different order 
bray_weight_adonis_terms2 <- adonis2(scaled_bray_dist ~ Weight * AgeRange * SampleSite, data = metadata_df, by = "terms")
bray_weight_adonis_terms2
```

**In the first model** where `Weight` is the final term, `Weight` explains only 2.7% of the variation in community composition after accounting for AgeRange and SampleSite, which was similar to the Sorensen results. It is also statistically significant (p < 0.041), so `Weight` does have an independent effect. *But in this model, Weight is tested after AgeGroup and SampleSite, so its effect is adjusted for their contributions.*

**In the second model** `Weight` now explains 3.8% of the variation, which is slightly higher and a similar result to the Soresen PERMANOVA. `Weight` is also significant (p < 0.001), while `AgeRange` is not (p > 0.05). Here, weight is tested first, so it “gets credit” for shared variance with AgeRange and also SampleSite. 

These two models together show that: 

1. Weight is important (significant in both models).
2. When interpreting effect size, contextualize the model structure:
    a. *Model 1:* weight’s unique contribution
    b. *Model 2:* weight’s overall contribution, overlapping with other factors. 

## Age's role in Community Composition

### Interpretation: What Does Age Mean Across Metrics?

1.	Significant across both distance types, AgeRange consistently affects community composition!
2.	Slightly higher R^2^ and F-stat in Sorensen indicates that AgeRange influences presence/absence (rare) patterns more than just abundance measured by the Bray-Curtis dissimilarity.
3.	Effect size changes depending on term order:
    - When entered first (Model 2): weight explains more variance, capturing shared effects with AgeRange.
    - When entered last (Model 1): weight explains a smaller, unique portion of variation.
4.	In Sorensen, there’s also a significant AgeRange × Weight interaction, which is consistent with turtles growing as they age.

Therefore, AgeRange is a major driver in this system and, we can accept our hypothesis at the beginning of this file!! :) Age's effect is robust across distance metrics (presence/absence and abundance), with more variation and separation explained by presence/absence. And, some of its influence may be shared with weight, so term order matters. Finally, in Sorensen, AgeRange affects who is present, suggesting an effect of rare species. 

*HOWEVER, there are caveats to these conclusions... let's take a look at variance!*

# 5b. Betadisper: Testing Variances/Dispersions

`betadisper()` is an important companion to PERMANOVA when analyzing beta diversity in microbial ecology. It checks a key assumption of PERMANOVA: homogeneity of group dispersions (variances). **If this assumption is violated, the PERMANOVA results might be driven by differences in spread rather than true differences in community composition.**

We will use the `betadisper()` and then the `permutest()` functions from the vegan package in R, which will perform an analysis of multivariate homogeneity of group dispersions—also called a PERMDISP test.

**Always run `betadisper()` and `permutest()` after PERMANOVA** to test whether the groups have similar within-group variation.

- If p > 0.05 (not significant), the PERMANOVA result is reliable.
- If p < 0.05 (significant), be cautious—group differences may be due to dispersion, not composition! However, not all is lost as we may expect this to be biologically true.  

**In Summary:**

| Function       | What it does                                                  | Significance test? | Output includes                    |
|----------------|---------------------------------------------------------------|---------------------|------------------------------------|
| `betadisper()` | Computes within-group distances to centroids (dispersion)     | ❌ No                | Distances, centroids, model object |
| `permutest()`  | Tests if group dispersions differ using permutations          | ✅ Yes               | F-value, permutation-based p-value |

## Sorensen

```{r betadisper-sorensen}
# Homogeneity of Disperson test with beta dispr
# Sorensen Betadisper - AgeRange
dispr_sorensen_AgeRange <- betadisper(scaled_sorensen_dist, metadata_df$AgeRange)
# permutest() performs a non-parametric permutation test, which is robust and valid for the kind of data used in beta diversity analysis (e.g., dissimilarity matrices).
permutest(dispr_sorensen_AgeRange)

TukeyHSD(dispr_sorensen_AgeRange)


# Sorensen Betadisper - SampleSite  
dispr_sorensen_SampleSite <- betadisper(scaled_sorensen_dist, metadata_df$SampleSite)
permutest(dispr_sorensen_SampleSite)

# Sorensen Betadisper - Weight kg  
dispr_sorensen_Weight <- betadisper(scaled_sorensen_dist, metadata_df$Weight)
permutest(dispr_sorensen_Weight)
```

Interpreting `betadisper()/permutest()` results (Interpretation 6):

**Sorensen:**

- **AgeRange** does not have a significant `betadisper()/permutest()` result (p > 0.05). Therefore, the PERMANOVA results likely represent a true difference by age.
-  **SampleSite** does not have a significant `betadisper()/permutest()` result (p > 0.05). Therefore, the PERMANOVA results likely represent a true difference by sample site.  
- **Weight** has a significant `betadisper()/permutest()` result (p < 0.002). We cannot conclude for certain that our PERMANOVA results are truly because of weight.

Interpretation 7: AgeRange and SampleSite are major drivers in this system! We can still accept our hypothesis at the beginning of this file! Age's effect is robust across distance metrics (presence/absence and abundance), with more variation and separation explained by presence/absence. Finally, in Sorensen, AgeRange affects who is present, suggesting an effect of rare species.

## Bray-Curtis

Now, let's test the same with Bray-Curtis!

```{r betadisper-bray}
# Bray-Curtis Betadisper - AgeRange 
dispr_bray_AgeRange <- betadisper(scaled_bray_dist, metadata_df$AgeRange)
permutest(dispr_bray_AgeRange)

# Bray-Curtis Betadisper - SampleSite 
dispr_bray_SampleSite <- betadisper(scaled_bray_dist, metadata_df$SampleSite)
permutest(dispr_bray_SampleSite)

# Bray-Curtis Betadisper - Weight kg 
dispr_bray_Weight <- betadisper(scaled_bray_dist, metadata_df$Weight)
permutest(dispr_bray_Weight)
```

The **Bray-Curtis** results are exactly in agreement with the Sorensen results. So, we can draw the same conclusions: 

1. AgeRange and SampleSite have homogeneity of variance, meaning that we can put more trust into the differences in the centroids that we discovered in the PERMANOVA results! 
1. Weight likely has some biological difference in the variance, which means that we need to be careful in our PERMANOVA interpretations.

# Interpreting PERMANOVA with Betadisper

### 📦 So how do you interpret both being significant?

If **PERMANOVA is significant** _and_ **betadisper is also significant**, it suggests that:

- Your groups **differ in community composition** (centroids), **but** also
- They may **differ in dispersion** (variance/spread), which can influence the PERMANOVA result

This raises the possibility that the PERMANOVA significance is at least partly driven by **differences in group variability**, not just true compositional shifts.

| Scenario                                       | Interpretation                                                               |
|------------------------------------------------|-------------------------------------------------------------------------------|
| ✅ PERMANOVA significant<br>❌ betadisper not significant | Likely true compositional differences (valid PERMANOVA result)                |
| ✅ PERMANOVA significant<br>✅ betadisper significant     | Differences may be due to dispersion, not centroids — interpret with caution |

**Next steps:**

- Use ordination plots to visually assess whether centroids are distinct or just differently dispersed (*We are about to do this!*)
- Plot distances to group centroids
- Consider running PERMANOVA on a subset with equal dispersions
- Reflect on ecological plausibility — are the dispersion differences biologically meaningful? Sometimes real biological processes cause both composition shifts and dispersion changes (e.g., disturbance, environmental heterogeneity)! So, don't lose your heart about your data yet! :) 

> Even with unequal dispersion, true ecological differences can still exist — the key is to **interpret with care** and use supporting evidence.

If this happens, the results could be written something like: "*PERMANOVA indicated significant differences in microbial community composition across treatments (p < 0.001), though betadisper was also significant (p = 0.03), suggesting differences in within-group dispersion. Ordination plots showed distinct clustering of treatment centroids, supporting genuine compositional differences, though interpretations must consider potential heterogeneity in dispersion.*"

# 6. Visualize Community Dissimilarity with Ordination

## What are ordination methods? 

**TLDR: Ordination = dimensionality reduction for complex ecological data.**

**Ordination methods** are a family of multivariate statistical techniques used to reduce the dimensionality of complex datasets and visualize patterns of similarity or dissimilarity among samples. In microbial ecology and community ecology more broadly, ordination helps reveal how microbial communities differ across samples based on environmental gradients, treatments, or other metadata.

Microbial community data (*e.g.,* 16S rRNA, metagenomics) often involve thousands of taxa across dozens to hundreds of samples. Ordination condenses this complexity into 2–3 axes that capture the main trends in community variation, allowing you to:

- Visualize clustering of similar samples
- Assess gradients (*e.g.,* nutrient, salinity, time)
- Explore community response to treatments or environments

##  Key Types of Ordination Methods

Please see the [Paliy & Shankar (2016)](https://onlinelibrary.wiley.com/doi/10.1111/mec.13536) paper for a great background and overview of various ordination methods. In summary: 

| Method                         | Type                          | Preserves                         | Typical Use Case                                                      |
|-------------------------------|-------------------------------|-----------------------------------|------------------------------------------------------------------------|
| **PCA** (Principal Component Analysis)       | Linear, metric                | Euclidean distances               | Abundance data, normalized counts                                     |
| **PCoA** (Principal Coordinates Analysis)    | Metric                        | Any dissimilarity metric          | Bray-Curtis, Jaccard, UniFrac; interpretable axes                     |
| **NMDS** (Non-metric Multidimensional Scaling) | Non-metric                    | Rank order of dissimilarities     | Complex, nonlinear ecological data; robust to outliers                |
| **CA** (Correspondence Analysis)             | Linear, unimodal response     | Chi-squared distances             | Species-by-site tables; assumes unimodal species response curves      |
| **CCA** (Canonical Correspondence Analysis)  | Constrained ordination        | Unimodal + environmental drivers  | Explains variation using environmental variables                      |
| **RDA** (Redundancy Analysis)                | Constrained ordination        | Linear + environmental drivers    | Like PCA but incorporates environmental predictors (e.g., pH, salinity) |


In practice, the most common ordination methods in microbial ecology are: 

1. **PCoA** - Eigen-based analysis, linear, axis coefficients are meaningful because they represent the eigenvectors. 
2. **NMDS** - Non-linear method, axes are not meaningful, smush many axes of data into 2 axes 

| Aspect                      | PCoA                                       | NMDS                                       |
|-----------------------------|--------------------------------------------|--------------------------------------------|
| **Basis**                   | Metric ordination (preserves distances)    | Non-metric (preserves rank order)          |
| **Output**                  | Axes with eigenvalues (% variance explained)| Configuration with stress value            |
| **Assumptions**             | Assumes distances can be represented in Euclidean space; may require transformation for non-Euclidean distances | No assumptions about linearity; focuses on rank ordering |
| **Advantages**              | Quantitative variance breakdown; interpretable axes | Robust to outliers and non-linear relationships; flexible with various distance measures |
| **Limitations**             | Sensitive to outliers; negative eigenvalues possible with certain distance metrics  | Axes are arbitrary; requires iterative optimization and multiple runs for stable solution |
| **Usage in Microbial Ecology** | Good when variance explained is important and distances meet metric assumptions | Often preferred for complex, non-linear ecological data where relative relationships are key |

# 6a. PCoA: Principal Coordinates Analysis

**PCoA**,starts with a distance (or dissimilarity) matrix calculated from microbial community data (e.g., Bray-Curtis, Jaccard) and then uses eigen decomposition to project samples into a low-dimensional space (typically 2 or 3 dimensions). PCoA is a metric technique—it strives to preserve the actual distances between samples. In other words, if two samples are very dissimilar in the original space, PCoA will represent them as far apart in the ordination.

**PCoA is eigen-based:** The method produces **eigenvalues** for each coordinate, which can be interpreted as the proportion of total variation explained by that axis. This lets you assess how well the low-dimensional space represents your data.

- **Eigenvalues** provide a quantitative measure of the variance captured by each dimension, which is useful for comparing ordination axes. Since it’s based on actual distances, interpretations (like “X% of variation explained”) can be directly tied to the original dissimilarity metrics.
    - Eigenvalues tell us how well our ordination captures the variability in beta diversity.
    - For example: If Axis 1 has an eigenvalue that explains 40% of the variation, and Axis 2 explains 20%, then plotting samples in 2D shows 60% of the total variation in the data.
- **Eigenvectors** Provide the coordinates of each sample along each PCoA axis (dimension). These coordinates are what is plotted in an ordination plot (*e.g.,* sample 1 at x = 0.2, y = -0.5). Therefore, the distances between points in the ordination plot approximate the original dissimilarities between samples.
    - Eigenvectors tell us where each sample falls along major ecological gradients (e.g., salinity, oxygen, host association), even if those gradients are not explicitly labeled.

| Term          | What it means                                 | Why it matters                                                              |
|---------------|-----------------------------------------------|-----------------------------------------------------------------------------|
| **Eigenvalue** | Variance explained by each PCoA axis          | Indicates how much of the community variation is captured by each dimension |
| **Eigenvector** | Coordinates of each sample on each axis       | Determines sample placement in the ordination plot; used for visualizing similarity/dissimilarity |

```{r pcoa-plots, fig.height=3.5, fig.width=7}
### SORENSEN 
# First, calculate PCoA with Soresen
scaled_soren_pcoa <- 
  ordinate(physeq = scaled_physeq,
         method = "PCoA",
         distance = "bray", binary = TRUE)

# Take a quick look
str(scaled_soren_pcoa)

# Plot it: Sorensen PCoA  
sorensen_pcoa_plot <- 
  plot_ordination(physeq = scaled_physeq,
                ordination = scaled_soren_pcoa,
                color = "AgeRange",
                shape = "SampleSite",
                title = "Sorensen PCoA") + 
  scale_color_manual(values = AgeRange_colors) + 
  scale_shape_manual(values = c(15, 16, 17)) + 
  geom_point(size = 5, alpha = 0.5, aes(color = AgeRange)) + 
  theme_bw() + 
  theme(legend.position = "right")

### Bray-Curtis 
# Second, calculate PCoA with Bray-Curtis
scaled_bray_pcoa <- 
  ordinate(physeq = scaled_physeq,
         method = "PCoA",
         distance = "bray", binary = FALSE)

# Plot it: Bray-Curtis PCoA 
bray_pcoa_plot <- 
  plot_ordination(physeq = scaled_physeq,
                ordination = scaled_bray_pcoa,
                color = "AgeRange",
                shape = "SampleSite",
                title = "Bray-Curtis PCoA") + 
  scale_color_manual(values = AgeRange_colors) + 
  scale_shape_manual(values = c(15, 16, 17)) + 
  geom_point(size = 5, alpha = 0.5, aes(color = AgeRange)) + 
  theme_bw() + 
  theme(legend.position = "right")

# Show the plots 
sorensen_pcoa_plot + bray_pcoa_plot + 
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A")
```

Above are two PCoA (Principal Coordinates Analysis) plots showing differences in microbial community composition across turtle sample sites and age ranges:

- **Left (Panel A):** Sorensen dissimilarity (presence/absence-based)
- **Right (Panel B):** Bray-Curtis dissimilarity (abundance-weighted)

We can conclude that (Interpretation 8): 

1. SampleSite is a dominant factor structuring microbial communities (Tank Water samples are separate from Cloacal and Oral).
2. AgeRange may be contributing in Sorensen, as most Juveniles are toward the extremes in Axis 1.
3. Sorensen highlights spatial patterns more strongly because between the two axes more variation is explained (~20%) than Bray-Curtis (~15%), suggesting that presence/absence differences among taxa matter in this system. We gain ~5% of more variation explained in the data in 2 axes without incorporating abundances.
4. Can there be some other more important factor?

## 6b. NMDS: Non-Metric Multidimensional Scaling 

**Non-metric Multidimensional Scaling (NMDS)** is a rank-based ordination method commonly used in microbial ecology to visualize differences in community composition. Unlike metric methods like PCoA, *NMDS does not preserve exact distances but instead maintains the rank order of dissimilarities between samples*. This makes it well-suited for ecological data that are high-dimensional, non-linear, and zero-inflated.

NMDS works by iteratively arranging samples in a low-dimensional space (typically 2D) to best match the original distance rankings from a dissimilarity matrix, such as Bray-Curtis. The quality of the fit is measured by stress—lower stress indicates a better match. Because NMDS does not assume linear relationships and is less prone to artifacts like the arch effect, it is ideal for exploring patterns in complex microbial datasets. Interpretation focuses on the relative positioning of samples rather than axis variance, making it especially useful for identifying ecological gradients or clustering by treatment or site.

In NMDS, the **stress value** is a key metric that quantifies how well the lower-dimensional ordination preserves the rank order of distances from the original high-dimensional dissimilarity matrix. In simple terms, stress reflects how faithfully the 2D or 3D plot represents the real structure of your microbial community data. The lower the stress, the better the ordination represents the data.

- **Stress < 0.1** is often reported as a strong result.
- **Stress < 0.2** is still commonly accepted but it's best if < 0.15, especially with complex, high-diversity microbiome data (*e.g.,* 16S or metagenomic datasets with many samples and ASVs).
- Some papers explicitly state they use NMDS for visualizing trends, not exact distances, so stress < 0.2 is considered acceptable in that context.
- It’s common to see NMDS with stress values between 0.08–0.15 in published studies.

*Okay, let's draw some NMDS plots!*

```{r soren-nmds}
## SORENSEN 
scaled_soren_nmds <- 
  ordinate(physeq = scaled_physeq,
         method = "NMDS",
         distance = "bray", binary = TRUE)

# Plot it! 
sorensen_nmds_plot <- 
  plot_ordination(physeq = scaled_physeq,
                ordination = scaled_soren_nmds,
                color = "AgeRange",
                shape = "SampleSite",
                title = "Sorensen NMDS") + 
  scale_color_manual(values = AgeRange_colors) + 
  scale_shape_manual(values = c(15, 16, 17)) + 
  geom_point(size = 5, alpha = 0.5, aes(color = AgeRange)) + 
  theme_bw() + 
  theme(legend.position = "right")

### Bray-Curtis 
# Second, calculate NMDS with Bray-Curtis
scaled_bray_nmds <- 
  ordinate(physeq = scaled_physeq,
         method = "NMDS",
         distance = "bray", binary = FALSE)

# Plot it: Bray-Curtis NMDS 
bray_nmds_plot <- 
  plot_ordination(physeq = scaled_physeq,
                ordination = scaled_bray_nmds,
                color = "AgeRange",
                shape = "SampleSite",
                title = "Bray-Curtis NMDS") + 
  scale_color_manual(values = AgeRange_colors) + 
  scale_shape_manual(values = c(15, 16, 17)) + 
  geom_point(size = 5, alpha = 0.5, aes(color = AgeRange)) + 
  theme_bw() + 
  theme(legend.position = "right")

# Show the plots 
sorensen_nmds_plot + bray_nmds_plot + 
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A")
```

Above are two NMDS plots showing differences in microbial community composition across turtle sample sites and age ranges:

- **Left (Panel A):** Sorensen dissimilarity (presence/absence-based)
- **Right (Panel B):** Bray-Curtis dissimilarity (abundance-weighted)

We can conclude that (Interpretation 9): 

1. The stress value for Sorensen is ~0.20 and for Bray-Curtis is ~0.21, which are both too high for a strong result.
2. Both Sorensen and Bray-Curtis look similar.
3. SampleSite seems to be a dominant factor structuring microbial communities (Tank Water samples are separate from Cloacal and Oral).
4. AgeRange doesn't look to be contributing significantly.
5. Can there be some other more important factor?

## All ordinations together!

```{r ordinations, fig.width=7, fig.height=6}
sorensen_pcoa_plot + bray_pcoa_plot + 
sorensen_nmds_plot + bray_nmds_plot + 
  plot_layout(guides = "collect") +
  plot_annotation(tag_levels = "A")
```

Interpretation 10: I think PCoA works best because the stress values for NMDS are too high. Additionally, the Sorensen PCoA is the only plot you could argue has some AgeRange differentiation. 

# Save data

```{r save-data}
save(scaled_physeq, 
     file = "data/06_Ordination/scaled_physeq.RData")
```


# Final info for Reproducibility 

## Check Render Time
```{r stop-time}
# Take the time now that we are at the end of the script
end_time <- Sys.time()
end_time 

# Echo the elapsed time
elapsed_time <- round((end_time - start_time), 3)
elapsed_time
```

## Session Information

```{r session-info}
# Ensure reproducibility with package version information
devtools::session_info()
```
